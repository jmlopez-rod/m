# AUTOGENERATED FILE - Update m/m.yaml
#   then run `m blueprints --update-workflow` to update
name: m

on:
  workflow_call:
    inputs:
      m-tag:
        type: string
        description: The unique version to use for all the images
        required: true
      cache-from-pr:
        type: string
        description: The pull request number to attempt to use as cache.
        required: true

permissions: write-all

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  M_TAG: ${{ inputs.m-tag }}
  CACHE_FROM_PR: ${{ inputs.cache-from-pr }}

jobs:
  blueprints:
    runs-on: ubuntu-22.04
    outputs:
      image-names: ${{ steps.m-blueprints.outputs.image-names }}
      image-tags: ${{ steps.m-blueprints.outputs.image-tags }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: install-m
        run: pip install git+https://github.com/jmlopez-rod/m.git@topic/docker
      - name: m-blueprints
        id: m-blueprints
        run: |-
          m blueprints
          {
            echo 'image-names=$(cat m/.m/blueprints/ci/_image-names.json)'
            echo 'image-tags=$(cat m/.m/blueprints/ci/_image-tags.json)'
          } >> $GITHUB_OUTPUT
      - name: archive
        uses: actions/upload-artifact@v3
        with:
          name: m-blueprints
          path: m/.m/blueprints/ci

  build:
    needs: blueprints
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            os: Ubuntu-20.04
          - arch: arm64
            os: Ubuntu-20.03
    runs-on: ${{ matrix.os }}
    env:
      ARCH: ${{ matrix.arch }}
    steps:
      - name: checkout
        uses: actions/checkout@v4
      - name: restore-m-blueprints
        uses: actions/download-artifact@v3
        with:
          name: m-blueprints
          path: m/.m/blueprints/ci
      - name: chmod
        run: chmod +x m/.m/blueprints/ci/*.sh
      - name: docker-login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: say hi
        run: echo 'hi'
      - name: do stuff
        uses: action/boo@v1
        with:
          param1: val
          param2: val2
      - name: m-image1 - cache
        run: m/.m/blueprints/ci/_find-cache.sh m-image1
      - name: m-image1 - build
        run: m/.m/blueprints/ci/m-image1.build.sh
      - name: m-image1 - push
        run: m/.m/blueprints/ci/_push-image.sh m-image1
      - name: m-image2 - cache
        run: m/.m/blueprints/ci/_find-cache.sh m-image2
      - name: m-image2 - build
        run: m/.m/blueprints/ci/m-image2.build.sh
      - name: m-image2 - push
        run: m/.m/blueprints/ci/_push-image.sh m-image2

  manifest:
    runs-on: ubuntu-22.04
    needs: [blueprints, build]
    strategy:
      matrix:
        image-name: ${{ fromJSON(needs.blueprints.outputs.image-names) }}
        image-tag: ${{ fromJSON(needs.blueprints.outputs.image-tags) }}
    steps:
      - name: docker-login
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: create
        run: |-
          docker manifest create ghcr.io/jmlopez-rod/${{ matrix.image-name }}:${{ matrix.image-tag }} \
            ghcr.io/jmlopez-rod/amd64-${{ matrix.image-name }}:${{ inputs.m-tag }} \
            ghcr.io/jmlopez-rod/arm64-${{ matrix.image-name }}:${{ inputs.m-tag }}
      - name: push
        run: |-
          docker manifest push ghcr.io/jmlopez-rod/${{ matrix.image-name }}:${{ matrix.image-tag }}
